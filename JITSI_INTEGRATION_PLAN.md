# План WebRTC-интеграции в Calendar и VideoCalls

## Текущее состояние
✅ Собственный WebRTC-провайдер реализован в `src/providers/VideoCallRealtimeProvider.tsx`
✅ Страница `VideoCalls.tsx` создаёт и подключается к сессиям Supabase (`video_call_sessions`)
✅ `Calendar.tsx` умеет запускать и подключаться к WebRTC-звонкам напрямую из событий
✅ Edge-функции `video-call-signal`, `video-call-cleanup`, `webpush-send` задеплоены

## Цели на ближайшее время
1. Завершить smoke-тесты WebRTC после деплоя на production
2. Реализовать отображение списка участников и их статусов в UI
3. Добавить управление приглашениями прямо из карточки события/встречи
4. Настроить автоматические напоминания (push/email) за N минут до встречи
5. Подготовить fallback-стратегию (например, SIP/VoIP или внешний сервис) на случай проблем с браузерным WebRTC

## Архитектура
- Supabase хранит сессии, участников и сигналы (`video_call_sessions`, `video_call_participants`, `video_call_signals`)
- Edge-функция `video-call-signal` принимает offer/answer/ICE и пишет в таблицу сигналов
- `VideoCallRealtimeProvider` слушает Realtime-каналы сигналов и участников, поддерживает единственный `RTCPeerConnection`
- `video-call-cleanup` периодически очищает устаревшие записи и завершает брошенные сессии
- `webpush-send` отправляет приглашения (необходимо настроить VAPID ключи и сервис-воркер)

## Следующие шаги разработки
1. **UI участников**: отображение имени/статуса, индикация микрофона/камеры, возможно – аватары
2. **Запись звонков / скриншоты** (опционально): исследовать способы записи peer connection
3. **Многопользовательский чат** внутри звонка (можно использовать Supabase Realtime)
4. **Мобильная оптимизация**: убедиться, что макет звонка корректно работает на iOS/Android
5. **Интеграция с задачами**: связывать сессии WebRTC с задачами/сделками для аудита

## Чек-лист по инфраструктуре
- [x] Применена миграция `20251017_video_call_core.sql`
- [x] Edge-функции задеплоены и настроены
- [ ] VAPID ключи добавлены в `.env` и Supabase Edge Config
- [ ] Cloud Scheduler/cron вызывает `video-call-cleanup`
- [ ] Мониторинг ошибок edge-функций настроен (Supabase logs + alerts)

## Вопросы на обсуждение
- Нужна ли запись звонков и где их хранить? (Supabase Storage, S3 и т.п.)
- Требуется ли интеграция с внешними телефонными сетями (SIP) или достаточно браузерного WebRTC?
- Какой SLA по доступности звонков и какие метрики мониторить?

---

Документ актуализирован: переход с Jitsi на собственный WebRTC-провайдер завершён; дальнейшие задачи перечислены выше.
