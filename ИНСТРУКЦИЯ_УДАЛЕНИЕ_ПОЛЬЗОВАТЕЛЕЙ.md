# Инструкция по развертыванию Edge Function для удаления пользователей

## Проблема
При попытке удалить пользователя через интерфейс Supabase Authentication возникает ошибка. Это происходит потому, что удаление пользователей требует специальных прав администратора и должно выполняться через API.

## Решение

### Шаг 1: Развертывание Edge Function

1. **Откройте терминал** в корне проекта `domio-ops`
2. **Убедитесь, что у вас установлен Supabase CLI**:
   ```bash
   supabase --version
   ```
   Если не установлен, установите:
   ```bash
   npm install -g supabase
   ```

3. **Войдите в Supabase**:
   ```bash
   supabase login
   ```

4. **Свяжите проект с удаленным проектом**:
   ```bash
   supabase link --project-ref YOUR_PROJECT_REF
   ```
   (Замените `YOUR_PROJECT_REF` на ID вашего проекта из Supabase Dashboard)

5. **Разверните Edge Function**:
   ```bash
   supabase functions deploy admin-delete-user
   ```

### Шаг 2: Проверка развертывания

1. **Откройте Supabase Dashboard**:
   - Перейдите на https://supabase.com
   - Выберите ваш проект `domio-ops`
   - В левом меню выберите **Edge Functions**

2. **Убедитесь, что функция `admin-delete-user` появилась в списке**

3. **Проверьте логи** (если есть ошибки):
   - Нажмите на функцию `admin-delete-user`
   - Перейдите на вкладку **Logs**

### Шаг 3: Тестирование функциональности

1. **Откройте приложение** и войдите как администратор
2. **Перейдите в Админ панель** (`/admin`)
3. **Откройте вкладку "Пользователи"**
4. **Попробуйте удалить пользователя** (кнопка с иконкой корзины)

### Шаг 4: Возможные проблемы и решения

#### Проблема: "Function not found"
**Решение**: Убедитесь, что функция развернута правильно:
```bash
supabase functions list
```

#### Проблема: "Unauthorized"
**Решение**: Проверьте, что:
- Пользователь имеет роль `admin` в таблице `user_roles`
- Токен авторизации передается корректно

#### Проблема: "Cannot delete your own account"
**Решение**: Это защитная мера - администратор не может удалить сам себя

#### Проблема: CORS ошибки
**Решение**: Edge Function уже настроена с правильными CORS заголовками

### Шаг 5: Альтернативные способы удаления пользователей

Если Edge Function не работает, можно удалить пользователей напрямую через Supabase Dashboard:

1. **Откройте Supabase Dashboard**
2. **Перейдите в Authentication → Users**
3. **Найдите пользователя** по email
4. **Нажмите на три точки** рядом с пользователем
5. **Выберите "Delete user"**

**Важно**: При удалении через Dashboard нужно также удалить связанные записи из таблиц `profiles` и `user_roles` вручную.

### Что делает Edge Function?

1. **Проверяет права администратора** - только пользователи с ролью `admin` могут удалять других пользователей
2. **Защищает от самоудаления** - администратор не может удалить сам себя
3. **Удаляет пользователя из Authentication** через Admin API
4. **Автоматически удаляет связанные данные** благодаря CASCADE constraints в таблицах `profiles` и `user_roles`

### Безопасность

- Функция использует Service Role Key для административных операций
- Проверяется авторизация через JWT токен
- Защита от CSRF атак через CORS настройки
- Валидация входных данных

## Готово!

После выполнения всех шагов вы сможете удалять пользователей через админ панель приложения без ошибок.
